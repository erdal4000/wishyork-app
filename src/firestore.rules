rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // --- COLLECTION GROUP RULES ---
    // These rules are essential for the main feed to work.
    // They allow signed-in users to perform 'list' queries across all users'
    // posts and wishlists collections. The actual data returned is still
    // filtered by the query in the application code.
    
    match /{path=**}/posts/{postId} {
      // Allow reading multiple documents (feed query) if signed in.
      allow list: if isSignedIn();
      // Allow reading or writing a single document if the user is the author.
      allow get, create, update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    match /{path=**}/wishlists/{wishlistId} {
      // Allow reading multiple documents (feed query) if signed in.
      allow list: if isSignedIn();
       // Allow reading a single document if it's public or the user is the author.
      allow get: if (resource.data.privacy == 'public') || (isSignedIn() && request.auth.uid == resource.data.authorId);
      // Allow writing a single document if the user is the author.
      allow create, update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }
    

    // --- USER-SPECIFIC DOCUMENT RULES ---

    match /users/{userId} {
      // Allow a user to read, update, and delete their own user document.
      allow read, update, delete: if isSignedIn() && request.auth.uid == userId;
      // Allow any signed-in user to create their user document.
      allow create: if isSignedIn();
    }

    match /usernames/{username} {
      // Allow any signed-in user to check if a username exists.
      allow read: if isSignedIn();
      // Only allow creation if the UID in the document matches the user's UID.
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.uid;
    }


    // --- SUB-COLLECTION RULES for direct access ---

    match /wishlists/{wishlistId}/items/{itemId} {
      // Allow the author of the wishlist to manage items.
      // Allow any signed-in user to read items (for reserving/fulfilling).
      allow read, write: if isSignedIn();
    }
    
    match /wishlists/{wishlistId}/comments/{commentId} {
        allow read, write: if isSignedIn();
    }
    
    match /posts/{postId}/comments/{commentId} {
        allow read, write: if isSignedIn();
    }
  }
}
