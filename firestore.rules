rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Kullanıcılar herkese açık profilleri okuyabilir.
    match /users/{userId} {
      allow read: if true;

      // Bir kullanıcı sadece kendi belgesini güncelleyebilir (bio, name vb. için).
      allow update: if request.auth != null && request.auth.uid == userId;

      // Takip Etme/Bırakma Mantığı:
      // Bir kullanıcı, başka bir kullanıcının 'followers' veya 'followersCount'
      // alanlarını ancak ve ancak kendi UID'sini ekleyip/çıkarıyorsa güncelleyebilir.
      // Bu, takip etme ve takipten çıkma işlemlerinin güvenli bir şekilde çalışmasını sağlar.
      allow update: if request.auth != null &&
                      (request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['followers', 'followersCount'])) &&
                      (request.resource.data.followers == resource.data.followers.concat([request.auth.uid]) ||
                       request.resource.data.followers == resource.data.followers.removed(request.auth.uid));
    }

    // Kullanıcı adlarının benzersizliğini kontrol etmek için herkesin okumasına izin ver.
    match /usernames/{username} {
      allow read, create: if true;
    }

    // Herkesin gönderileri okumasına izin ver.
    // Bir kullanıcı sadece kendi gönderisini oluşturabilir/silebilir/güncelleyebilir.
    match /posts/{postId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }

    // Wishlistler için kurallar
    match /wishlists/{wishlistId} {
      // Herkes herkese açık wishlistleri okuyabilir.
      // Kullanıcılar kendi özel veya arkadaş listelerini okuyabilir.
      allow read: if resource.data.privacy == 'public' || 
                     (request.auth != null && request.auth.uid == resource.data.authorId);
      
      // Kullanıcılar sadece kendi wishlistlerini oluşturabilir, güncelleyebilir, silebilir.
      allow create, update, delete: if request.auth != null && request.auth.uid == request.resource.data.authorId;

      // Wishlist içindeki item'lar için kurallar
      match /items/{itemId} {
        // Wishlist'i okuma izni olan herkes item'ları da okuyabilir.
        allow read: if get(/databases/$(database)/documents/wishlists/$(wishlistId)).data.privacy == 'public' ||
                     (request.auth != null && request.auth.uid == get(/databases/$(database)/documents/wishlists/$(wishlistId)).data.authorId);
        
        // Wishlist sahibi item ekleyebilir/silebilir/güncelleyebilir.
        allow create, delete: if request.auth != null && request.auth.uid == get(/databases/$(database)/documents/wishlists/$(wishlistId)).data.authorId;
        
        // Oturum açmış herhangi bir kullanıcı bir item'ı rezerve edebilir, satın alındı olarak işaretleyebilir veya rezervasyonunu iptal edebilir.
        allow update: if request.auth != null;
      }
    }

  }
}
